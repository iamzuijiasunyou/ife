!function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={exports:{},id:r,loaded:!1};return e[r].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t){!function(){function e(e,t,n,i){this.id=e,this.power=100,this.bus=null,this.radius=10+40*e,this.deg=0,this.speed=t||r,this.chRate=n||o,this.conRate=i||a,this.timer=null,this.state="stop"}function t(){this.id="kangheitan",this.bus=null,this.cmds=[]}function n(e){function t(){var t=this,n=t.dataset.op,r=t.parentNode.index,o=new w(r,n);e.sendCommand(o)}var n=document.querySelector(".commander-panel ul").children,r=document.getElementsByTagName("button");r=Array.from(r),n=Array.from(n),n.forEach(function(e,t){e.index=t+1}),r.forEach(function(e,n){e.onclick=t})}var r=3,o=2,a=5,i=400,c=400,s=300,d=.1,u="#00AAFF",l="#00DF2D",f="#FC0000",p=19,h=23,m=8,g=50;e.prototype.dynamicManager=function(){var e=this,t=function(){e.timer=setInterval(function(){e.deg+=e.speed*g/e.radius,e.deg>=360&&(e.deg=0)},30)},n=function(){clearInterval(e.timer),y.log("Spaceship No."+e.id+" is stopped.")};return{fly:t,stop:n}},e.prototype.powerManager=function(){var e=this,t=function(){var t=setInterval(function(){return"stop"!==e.state?void clearInterval(t):e.power>=100?(clearInterval(t),void(e.power=100)):void(e.power+=e.chRate)},1e3);y.log("飞船 No."+e.id+"号正在充电.")},n=function(){var t=setInterval(function(){return"fly"!==e.state?void clearInterval(t):e.power<e.conRate?(clearInterval(t),y.log("飞船 No."+e.id+"号燃油即将耗尽."),e.power=0,void e.StateManager().setState("stop")):void(e.power-=e.conRate)},1e3);y.log("飞船 No."+e.id+"能量正在减少.")};return{charge:t,consume:n}},e.prototype.StateManager=function(){var e=this,t={fly:function(){e.dynamicManager().fly(),e.powerManager().consume()},stop:function(){e.dynamicManager().stop(),e.powerManager().charge()},destroy:function(){e.state="destroy",e.bus.remove(e)}},n=function(n){e.state=n,t[n]&&t[n](),y.log("飞船 No."+e.id+" 状态为 "+n)};return{setState:n}},e.prototype.SingleManager=function(){var t=this,n=function(n){var r=e.Adapter(n);t.id===r.id&&t.StateManager().setState(r.command)};return{recieve:n}},e.Adapter=function(e){var t,n=parseInt(e.slice(1,3)),r=e.slice(4);switch(r){case"0001":t="fly";break;case"0010":t="stop";break;case"0100":t="destroy";break;default:throw new Error("错误的指令")}return{id:n,command:t}},t.prototype.sendCommand=function(e){if(this.bus)if("init"===e.command)this.bus.create(e);else{var n=t.Aadapter(e);this.cmds.push(n),this.bus.send(n)}},t.Aadapter=function(e){var t,n="i"+(e.id>=10?e.id:"0"+e.id)+"d";switch(e.command){case"fly":t="0001";break;case"stop":t="0010";break;case"destroy":t="0100";break;default:t=e.command}return n+t};var v=function(){var n=null,r=[];return{send:function(e){setTimeout(function(){if(e){for(var t=Math.random()<d;t;)y.log("丢包!!","error"),t=Math.random()<d;y.log("信号发射成功!"),r.forEach(function(t,n){t.SingleManager().recieve(e)})}},s)},register:function(o){if(o instanceof t)n=o,o.bus=this,y.log("指挥官注册成功："+o.id);else{if(!(o instanceof e))throw new Error("参数错误");r[o.id]=o,o.bus=this}},create:function(t){if(r[t.id])return void y.log("飞船已存在："+t.id);var n,o,a=document.querySelector("input[name='dynamic']:checked"),i=document.querySelector("input[name='power']:checked");a&&(n=a.value.split(",")[0],o=a.value.split(",")[1]),i&&(i=i.value),console.log(+n,+i,+o);var c=new e(t.id,+n,+i,+o);this.register(c),y.log("飞船注册成功："+c.id)},remove:function(t){t instanceof e?delete r[t.id]:y.show("飞船销毁失败")},getShips:function(){return r}}},w=function(e,t){this.id=e,this.command=t},y={ele:document.querySelector(".console-log"),log:function(e,t){var n=document.createElement("p");n.innerHTML=e,t&&(n.className=t),this.ele.appendChild(n)}},S=function(){function e(e){d=e}function t(e){e.save(),e.translate(i/2,c/2);for(var t=1;t<=4;t++)e.beginPath(),e.strokeStyle="#aaa",e.arc(0,0,10+40*t,0,2*Math.PI),e.closePath(),e.stroke();e.restore()}function n(e,t){e.save(),e.rotate(-t.deg*Math.PI/180),e.drawImage(o,t.radius-p/2,-h/2),e.font="15px serif",e.fillText(t.id+"号",t.radius-10,h),t.power>=60?e.fillStyle=u:t.power<60&&t.power>=30?e.fillStyle=l:e.fillStyle=f,e.fillRect(t.radius-p/2,-h,p*t.power/100,m),e.restore()}function r(e){var t=document.createElement("canvas");t.width=i,t.height=c,s=t.getContext("2d"),s.clearRect(0,0,i,c),s.translate(i/2,c/2),e.forEach(function(e,t){n(s,e)}),s=a.getContext("2d"),a.clearRect(0,0,i,c),s.drawImage(t,0,0,i,c)}var o=new Image;o.src="./dist/ship.png";var a=document.getElementById("canvas"),s=a.getContext("2d");a.width=i,a.height=c;var d=null,g=function(){requestAnimationFrame(g),r(d.getShips())};return function(){var e=document.getElementById("layer"),n=e.getContext("2d");e.width=i,e.height=c,n.clearRect(0,0,i,c),t(n)}(),{setBUS:e,animLoop:g}}();window.onload=function(){var e=new t,r=new v;r.register(e),n(e),S.setBUS(r),S.animLoop()}}()}]);